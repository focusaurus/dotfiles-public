#!/usr/bin/env bash

# Please Use Google Shell Style: https://google.github.io/styleguide/shell.xml

# ---- Start unofficial bash strict mode boilerplate
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -o errexit  # always exit on error
set -o errtrace # trap errors in functions as well
set -o pipefail # don't ignore exit codes when piping output
# set -x # enable debugging

IFS=$'\n\t'
# ---- End unofficial bash strict mode boilerplate

usage() {
  cat <<EOF
Renders data into a tera template then processes the markdown to HTML then PDF.

Pass filenames on the command line. Position doesn't matter, just filename extensions.

The .md is the template, .json is the data, and .pdf is the output.
EOF
}

template="/dev/stdin"
data="/dev/stdin"
output="/dev/stdout"
ok="n"
for arg in "$@"; do
  case "${arg}" in
  *.md)
    template="${arg}"
    ok="y"
    ;;
  *.json)
    data="${arg}"
    ok="y"
    ;;
  *.pdf)
    output="${arg}"
    ;;
  *)
    echo "Expecting arguments in any order but with extensions: .md, .json, or .pdf. Not ${arg}" 1>&2
    exit 10
    ;;
  esac
done
if [[ "${ok}" == "n" ]]; then
  echo "you must provide one of --template or --data on the command line" 1>&2
  exit 11
fi
tera --template "${template}" --stdin <"${data}" | ~/bin/md-to-pdf >"${output}"
